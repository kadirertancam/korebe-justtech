// power-ups.js
// K√∂rebe oyunu i√ßin g√º√ß-up sistemi

// T√ºm g√º√ß-up tiplerini tanƒ±mla
const POWERUP_TYPES = {
    SPEED_POTION: {
        id: 'speed_potion',
        name: 'Hƒ±z ƒ∞ksiri',
        description: 'Hƒ±zƒ±nƒ±zƒ± 10 saniye boyunca artƒ±rƒ±r',
        duration: 10000,
        iconColor: '#3498db',
        iconSymbol: '‚ö°',
        rarity: 'common',
        // Sadece ebe olmayanlar kullanabilir
        validFor: (isEbe) => !isEbe
    },
    INVISIBILITY: {
        id: 'invisibility',
        name: 'G√∂r√ºnmezlik Pelerini',
        description: '10 saniye boyunca neredeyse tamamen g√∂r√ºnmez olursunuz',
        duration: 10000,
        iconColor: '#9b59b6',
        iconSymbol: 'üëª',
        rarity: 'rare',
        // Sadece ebe olmayanlar kullanabilir
        validFor: (isEbe) => !isEbe
    },
    SILENT_STEPS: {
        id: 'silent_steps',
        name: 'Sessiz Adƒ±mlar',
        description: '15 saniye boyunca ayak izi bƒ±rakmazsƒ±nƒ±z',
        duration: 15000,
        iconColor: '#2ecc71',
        iconSymbol: 'üë£',
        rarity: 'uncommon',
        // Sadece ebe olmayanlar kullanabilir
        validFor: (isEbe) => !isEbe
    },
    RADAR: {
        id: 'radar',
        name: 'Radar',
        description: '5 saniye boyunca ebenin konumunu g√∂sterir',
        duration: 5000,
        iconColor: '#f1c40f',
        iconSymbol: 'üì°',
        rarity: 'uncommon',
        // Sadece ebe olmayanlar kullanabilir
        validFor: (isEbe) => !isEbe
    },
    LANTERN: {
        id: 'lantern',
        name: 'Fener',
        description: '15 saniye boyunca g√∂r√º≈ü a√ßƒ±nƒ±z geni≈üler',
        duration: 15000,
        iconColor: '#e67e22', 
        iconSymbol: 'üî¶',
        rarity: 'common',
        // Sadece ebeler kullanabilir
        validFor: (isEbe) => isEbe
    },
    DASH_RECHARGE: {
        id: 'dash_recharge',
        name: 'Dash ≈ûarjƒ±',
        description: 'T√ºm dash haklarƒ±nƒ±zƒ± anƒ±nda doldurur',
        duration: 0, // Anlƒ±k etki
        iconColor: '#e74c3c',
        iconSymbol: 'üí®',
        rarity: 'uncommon',
        // Sadece ebeler kullanabilir
        validFor: (isEbe) => isEbe
    }
};

// G√º√ß-up y√∂neticisi
class PowerUpManager {
    constructor(player, gameState) {
        this.player = player;
        this.gameState = gameState;
        this.activePowerUps = [];
        this.inventory = [];
        this.maxInventory = 3; // Maksimum 3 g√º√ß-up ta≈üƒ±yabilir
        this.spawnPoints = []; // G√º√ß-up olu≈üturma noktalarƒ±
        this.worldPowerUps = []; // D√ºnyada bulunan g√º√ß-uplar
        this.powerUpElements = {}; // UI elementleri
        this.UI = null; // Ana UI element
        
        // Modifikasyon katsayƒ±larƒ± - g√º√ß-uplar bunlarƒ± etkiler
        this.modifiers = {
            speedMultiplier: 1,
            visibilityMultiplier: 1,
            leavesFootprints: true,
            viewAngleMultiplier: 1,
            viewDistanceMultiplier: 1
        };
        
        // Event listener'larƒ±
        this.eventListeners = {
            onPowerUpCollected: [],
            onPowerUpActivated: [],
            onPowerUpDeactivated: [],
            onPowerUpExpired: []
        };
    }
    
    // Oyuncunun g√ºncel modifikasyonlarƒ±nƒ± al
    getModifiers() {
        return {...this.modifiers};
    }
    
    // G√º√ß-up olu≈üturma noktalarƒ± olu≈ütur
    setupSpawnPoints(maze, tileSize) {
        this.spawnPoints = [];
        
        // Labirentin bo≈ü alanlarƒ±nda rastgele g√º√ß-up spawn noktalarƒ± olu≈ütur
        for (let y = 0; y < maze.length; y++) {
            for (let x = 0; x < maze[y].length; x++) {
                // Bo≈ü alanlarda (0) ve gizlenme yerlerinde (2) g√º√ß-up olu≈üturabilir
                if (maze[y][x] === 0 || maze[y][x] === 2) {
                    // Her bo≈ü alan bir spawn noktasƒ± deƒüil - rastgele se√ß
                    if (Math.random() < 0.05) { // %5 ihtimalle
                        this.spawnPoints.push({
                            x: x * tileSize + tileSize / 2,
                            y: y * tileSize + tileSize / 2
                        });
                    }
                }
            }
        }
        
        console.log(`${this.spawnPoints.length} g√º√ß-up spawn noktasƒ± olu≈üturuldu`);
    }
    
    // D√ºnyada g√º√ß-up olu≈ütur
    spawnPowerUps(count = 5) {
        if (this.spawnPoints.length === 0) {
            console.error('G√º√ß-up olu≈üturma noktalarƒ± ayarlanmamƒ±≈ü!');
            return;
        }
        
        // Belirtilen sayƒ±da g√º√ß-up olu≈ütur
        for (let i = 0; i < count; i++) {
            // Rastgele bir spawn noktasƒ± se√ß
            const spawnIndex = Math.floor(Math.random() * this.spawnPoints.length);
            const spawnPoint = this.spawnPoints[spawnIndex];
            
            // Rastgele bir g√º√ß-up tipi se√ß
            const powerUpTypes = Object.values(POWERUP_TYPES);
            let selectedType;
            let attempts = 0;
            
            // Oyuncu i√ßin ge√ßerli bir g√º√ß-up se√ß (ebe durumuna g√∂re)
            do {
                const randomIndex = Math.floor(Math.random() * powerUpTypes.length);
                selectedType = powerUpTypes[randomIndex];
                attempts++;
                
                // Sonsuz d√∂ng√ºye girmeyi √∂nlemek i√ßin
                if (attempts > 20) {
                    // Varsayƒ±lan olarak herkes i√ßin ge√ßerli bir g√º√ß-up se√ß
                    selectedType = POWERUP_TYPES.SPEED_POTION;
                    break;
                }
            } while (!this.isValidSpawn(selectedType));
            
            // D√ºnyaya g√º√ß-up ekle
            this.worldPowerUps.push({
                type: selectedType,
                x: spawnPoint.x,
                y: spawnPoint.y,
                radius: 15, // G√º√ß-up boyutu
                spawnTime: Date.now(),
                pulsePhase: Math.random() * Math.PI * 2 // Rastgele ba≈ülangƒ±√ß fazƒ±
            });
        }
    }
    
    // Belirli bir oyun durumunda (ebe vs normal) g√º√ß-up olu≈üumu ge√ßerli mi?
    isValidSpawn(powerUpType) {
        // Rastgele olasƒ±lƒ±k - nadir g√º√ß-uplar daha az sƒ±klƒ±kla olu≈üur
        let rarityChance = 1;
        switch (powerUpType.rarity) {
            case 'common': rarityChance = 0.6; break;
            case 'uncommon': rarityChance = 0.3; break;
            case 'rare': rarityChance = 0.1; break;
        }
        
        if (Math.random() > rarityChance) {
            return false;
        }
        
        // Oyun moduna g√∂re (ebe/normal) filtrele
        return true; // Basitle≈ütirilmi≈ü - t√ºm g√º√ß-uplar olu≈üturulabilir
    }
    
    // G√º√ß-up toplama kontrol√º
    checkPowerUpCollection(playerX, playerY, playerSize) {
        const collectedIndices = [];
        
        // D√ºnya √ºzerindeki t√ºm g√º√ß-uplarƒ± kontrol et
        this.worldPowerUps.forEach((powerUp, index) => {
            const dist = this.distance(playerX, playerY, powerUp.x, powerUp.y);
            
            // Toplama mesafesi kontrol√º
            if (dist < playerSize + powerUp.radius) {
                // G√º√ß-up'ƒ± envanterimize ekle, fakat envanter doluysa ekleme
                if (this.inventory.length < this.maxInventory) {
                    this.inventory.push(powerUp.type);
                    collectedIndices.push(index);
                    
                    // Toplama olayƒ±nƒ± tetikle
                    this.triggerEvent('onPowerUpCollected', powerUp.type);
                    
                    // UI'ƒ± g√ºncelle
                    this.updateUI();
                } else {
                    console.log('Envanter dolu, g√º√ß-up toplanamadƒ±!');
                }
            }
        });
        
        // Toplanan g√º√ß-uplarƒ± d√ºnyadan kaldƒ±r (tersten giderek indeks karƒ±≈üƒ±klƒ±ƒüƒ± olmamasƒ± i√ßin)
        for (let i = collectedIndices.length - 1; i >= 0; i--) {
            this.worldPowerUps.splice(collectedIndices[i], 1);
        }
        
        // Eƒüer d√ºnyada az sayƒ±da g√º√ß-up kaldƒ±ysa yeni g√º√ß-uplar olu≈ütur
        if (this.worldPowerUps.length < 3 && Math.random() < 0.01) { // %1 ≈üans
            this.spawnPowerUps(1); // Yeni bir g√º√ß-up olu≈ütur
        }
    }
    
    // G√º√ß-uplarƒ± √ßiz
    drawPowerUps(ctx, camera) {
        const currentTime = Date.now();
        
        ctx.save();
        
        // D√ºnya √ºzerindeki g√º√ß-uplarƒ± √ßiz
        this.worldPowerUps.forEach(powerUp => {
            // Pulsing (yanƒ±p s√∂nen) efekt i√ßin hesaplamalar
            const pulseSpeed = 2; // Nabƒ±z hƒ±zƒ±
            const elapsedTime = (currentTime - powerUp.spawnTime) / 1000;
            const pulseFactor = 0.2 * Math.sin(pulseSpeed * elapsedTime + powerUp.pulsePhase) + 1;
            
            // G√º√ß-up dairesini √ßiz
            ctx.fillStyle = powerUp.type.iconColor;
            ctx.beginPath();
            ctx.arc(powerUp.x, powerUp.y, powerUp.radius * pulseFactor, 0, Math.PI * 2);
            ctx.fill();
            
            // G√º√ß-up sembol√ºn√º √ßiz
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(powerUp.type.iconSymbol, powerUp.x, powerUp.y);
        });
        
        ctx.restore();
    }
    
    // G√º√ß-up kullan
    activatePowerUp(index) {
        if (index < 0 || index >= this.inventory.length) {
            console.error('Ge√ßersiz g√º√ß-up indeksi!');
            return false;
        }
        
        const powerUpType = this.inventory[index];
        
        // G√º√ß-up, mevcut oyuncu durumu i√ßin ge√ßerli mi kontrol et
        if (!powerUpType.validFor(this.gameState.isEbe)) {
            console.log(`${powerUpType.name} ≈üu anda kullanƒ±lamaz (ebe durumuna uygun deƒüil)`);
            return false;
        }
        
        // G√º√ß-up'ƒ± envanterden kaldƒ±r
        this.inventory.splice(index, 1);
        
        // Aktif g√º√ß-up listesine ekle (s√ºreli etkileri olanlar i√ßin)
        if (powerUpType.duration > 0) {
            const activePowerUp = {
                type: powerUpType,
                startTime: Date.now(),
                endTime: Date.now() + powerUpType.duration,
                id: Math.random().toString(36).substring(2, 9) // Benzersiz ID
            };
            
            this.activePowerUps.push(activePowerUp);
            
            // G√º√ß-up etkilerini uygula
            this.applyPowerUpEffects(powerUpType, true);
            
            // G√º√ß-up'ƒ±n s√ºresini kontrol etmek i√ßin zamanlayƒ±cƒ±
            setTimeout(() => {
                this.deactivatePowerUp(activePowerUp.id);
            }, powerUpType.duration);
            
            // Aktifle≈ütirme olayƒ±nƒ± tetikle
            this.triggerEvent('onPowerUpActivated', powerUpType);
        } else {
            // Anlƒ±k etkisi olan g√º√ß-uplar i√ßin
            this.applyInstantPowerUpEffect(powerUpType);
            
            // Aktifle≈ütirme olayƒ±nƒ± tetikle
            this.triggerEvent('onPowerUpActivated', powerUpType);
            
            // Anƒ±nda sona erme olayƒ±nƒ± tetikle
            this.triggerEvent('onPowerUpExpired', powerUpType);
        }
        
        // UI'ƒ± g√ºncelle
        this.updateUI();
        
        return true;
    }
    
    // G√º√ß-up'ƒ± devre dƒ±≈üƒ± bƒ±rak
    deactivatePowerUp(powerUpId) {
        const index = this.activePowerUps.findIndex(p => p.id === powerUpId);
        
        if (index === -1) return false;
        
        const powerUp = this.activePowerUps[index];
        
        // G√º√ß-up'ƒ± aktif listeden kaldƒ±r
        this.activePowerUps.splice(index, 1);
        
        // G√º√ß-up etkilerini kaldƒ±r
        this.applyPowerUpEffects(powerUp.type, false);
        
        // Devre dƒ±≈üƒ± bƒ±rakma olayƒ±nƒ± tetikle
        this.triggerEvent('onPowerUpDeactivated', powerUp.type);
        
        // Sona erme olayƒ±nƒ± tetikle
        this.triggerEvent('onPowerUpExpired', powerUp.type);
        
        // UI'ƒ± g√ºncelle
        this.updateUI();
        
        return true;
    }
    
    // Aktif g√º√ß-uplarƒ±n durumunu g√ºncelle
    updateActivePowerUps() {
        const currentTime = Date.now();
        const expiredPowerUps = [];
        
        // S√ºresi dolan g√º√ß-uplarƒ± bul
        this.activePowerUps.forEach(powerUp => {
            if (currentTime >= powerUp.endTime) {
                expiredPowerUps.push(powerUp.id);
            }
        });
        
        // S√ºresi dolan g√º√ß-uplarƒ± devre dƒ±≈üƒ± bƒ±rak
        expiredPowerUps.forEach(powerUpId => {
            this.deactivatePowerUp(powerUpId);
        });
    }
    
    // G√º√ß-up'ƒ±n etkilerini uygula/kaldƒ±r
    applyPowerUpEffects(powerUpType, activate) {
        // Her g√º√ß-up tipi i√ßin farklƒ± etkiler
        switch (powerUpType.id) {
            case 'speed_potion':
                // Hƒ±z modifikasyonu
                if (activate) {
                    this.modifiers.speedMultiplier = 2.0; // 2x hƒ±z
                } else {
                    this.modifiers.speedMultiplier = 1.0; // Normal hƒ±z
                }
                break;
                
            case 'invisibility':
                // G√∂r√ºn√ºrl√ºk modifikasyonu
                if (activate) {
                    this.modifiers.visibilityMultiplier = 0.2; // %20 g√∂r√ºn√ºrl√ºk (neredeyse g√∂r√ºnmez)
                } else {
                    this.modifiers.visibilityMultiplier = 1.0; // Normal g√∂r√ºn√ºrl√ºk
                }
                break;
                
            case 'silent_steps':
                // Ayak izi bƒ±rakma modifikasyonu
                if (activate) {
                    this.modifiers.leavesFootprints = false; // Ayak izi bƒ±rakmaz
                } else {
                    this.modifiers.leavesFootprints = true; // Normal ayak izi bƒ±rakƒ±r
                }
                break;
                
            case 'radar':
                // Radar modifikasyonu - client tarafƒ±nda √∂zel i≈ülem gerektirir
                if (activate) {
                    this.gameState.radarActive = true;
                } else {
                    this.gameState.radarActive = false;
                }
                break;
                
            case 'lantern':
                // G√∂r√º≈ü a√ßƒ±sƒ± modifikasyonu
                if (activate) {
                    this.modifiers.viewAngleMultiplier = 1.5; // G√∂r√º≈ü a√ßƒ±sƒ± %50 artar
                    this.modifiers.viewDistanceMultiplier = 1.3; // G√∂r√º≈ü mesafesi %30 artar
                } else {
                    this.modifiers.viewAngleMultiplier = 1.0; // Normal g√∂r√º≈ü a√ßƒ±sƒ±
                    this.modifiers.viewDistanceMultiplier = 1.0; // Normal g√∂r√º≈ü mesafesi
                }
                break;
        }
    }
    
    // Anlƒ±k etkili g√º√ß-uplar i√ßin
    applyInstantPowerUpEffect(powerUpType) {
        switch (powerUpType.id) {
            case 'dash_recharge':
                // Dash haklarƒ±nƒ± anƒ±nda doldur
                if (this.player.dashCount !== undefined) {
                    this.player.dashCount = this.player.maxDashCount || 3; // Maksimum dash hakkƒ±
                }
                break;
                
            // Diƒüer anlƒ±k etkili g√º√ß-uplar burada eklenebilir
        }
    }
    
    // Event sistemi
    addEventListener(event, callback) {
        if (this.eventListeners[event]) {
            this.eventListeners[event].push(callback);
        }
    }
    
    removeEventListener(event, callback) {
        if (this.eventListeners[event]) {
            this.eventListeners[event] = this.eventListeners[event].filter(cb => cb !== callback);
        }
    }
    
    triggerEvent(event, data) {
        if (this.eventListeners[event]) {
            this.eventListeners[event].forEach(callback => callback(data));
        }
    }
    
    // Yardƒ±mcƒ± fonksiyonlar
    distance(x1, y1, x2, y2) {
        return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
    }
    
    // UI hazƒ±rlama
    setupUI() {
        // Daha √∂nceden olu≈üturulmu≈ü bir UI element varsa temizle
        if (this.UI) {
            this.UI.remove();
        }
        
        // Ana UI container
        this.UI = document.createElement('div');
        this.UI.id = 'powerup-ui';
        this.UI.className = 'game-ui-element';
        this.UI.style.cssText = `
            position: absolute;
            left: 10px;
            top: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        `;
        
        // UI ba≈ülƒ±ƒüƒ±
        const title = document.createElement('div');
        title.textContent = 'G√º√ß-Uplar';
        title.style.cssText = `
            color: white;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: center;
        `;
        this.UI.appendChild(title);
        
        // G√º√ß-uplar container
        const powerupsContainer = document.createElement('div');
        powerupsContainer.id = 'powerups-container';
        powerupsContainer.style.cssText = `
            display: flex;
            gap: 5px;
        `;
        this.UI.appendChild(powerupsContainer);
        
        // G√º√ß-up slotlarƒ±
        for (let i = 0; i < this.maxInventory; i++) {
            const slot = document.createElement('div');
            slot.className = 'powerup-slot';
            slot.dataset.index = i;
            slot.style.cssText = `
                width: 40px;
                height: 40px;
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 20px;
                color: white;
                cursor: pointer;
                position: relative;
            `;
            
            // Tu≈ü kƒ±sayolu etiketi
            const keyLabel = document.createElement('div');
            keyLabel.textContent = (i + 1).toString();
            keyLabel.style.cssText = `
                position: absolute;
                bottom: 2px;
                right: 2px;
                font-size: 10px;
                color: rgba(255, 255, 255, 0.7);
            `;
            slot.appendChild(keyLabel);
            
            // Slot'a tƒ±klandƒ±ƒüƒ±nda g√º√ß-up kullan
            slot.addEventListener('click', () => {
                this.activatePowerUp(i);
            });
            
            powerupsContainer.appendChild(slot);
            this.powerUpElements[i] = slot;
        }
        
        // Aktif g√º√ß-uplar container
        const activeContainer = document.createElement('div');
        activeContainer.id = 'active-powerups';
        activeContainer.style.cssText = `
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        `;
        this.UI.appendChild(activeContainer);
        
        // Document body'e ekle
        document.body.appendChild(this.UI);
        
        // UI'ƒ± ilk kez g√ºncelle
        this.updateUI();
    }
    
    // UI g√ºncelleme
    updateUI() {
        if (!this.UI) {
            this.setupUI();
            return;
        }
        
        // Envanterdeki g√º√ß-uplarƒ± g√ºncelle
        for (let i = 0; i < this.maxInventory; i++) {
            const slot = this.powerUpElements[i];
            
            if (i < this.inventory.length) {
                const powerUpType = this.inventory[i];
                slot.innerHTML = ''; // ƒ∞√ßeriƒüi temizle
                
                // G√º√ß-up ikonu
                const icon = document.createElement('div');
                icon.textContent = powerUpType.iconSymbol;
                icon.style.cssText = `
                    font-size: 24px;
                `;
                slot.appendChild(icon);
                
                // G√º√ß-up tu≈ü kƒ±sayolu
                const keyLabel = document.createElement('div');
                keyLabel.textContent = (i + 1).toString();
                keyLabel.style.cssText = `
                    position: absolute;
                    bottom: 2px;
                    right: 2px;
                    font-size: 10px;
                    color: rgba(255, 255, 255, 0.7);
                `;
                slot.appendChild(keyLabel);
                
                // Arka plan rengini g√º√ß-up'a g√∂re ayarla
                slot.style.backgroundColor = powerUpType.iconColor;
                
                // Tooltip ekle
                slot.title = `${powerUpType.name}: ${powerUpType.description}`;
            } else {
                // Bo≈ü slot
                slot.innerHTML = '';
                slot.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                slot.title = 'Bo≈ü slot';
                
                // G√º√ß-up tu≈ü kƒ±sayolu
                const keyLabel = document.createElement('div');
                keyLabel.textContent = (i + 1).toString();
                keyLabel.style.cssText = `
                    position: absolute;
                    bottom: 2px;
                    right: 2px;
                    font-size: 10px;
                    color: rgba(255, 255, 255, 0.7);
                `;
                slot.appendChild(keyLabel);
            }
        }
        
        // Aktif g√º√ß-uplarƒ± g√ºncelle
        const activeContainer = document.getElementById('active-powerups');
        activeContainer.innerHTML = '';
        
        this.activePowerUps.forEach((powerUp) => {
            const remainingTime = Math.max(0, powerUp.endTime - Date.now());
            const remainingSeconds = Math.ceil(remainingTime / 1000);
            
            const activeItem = document.createElement('div');
            activeItem.className = 'active-powerup-item';
            activeItem.style.cssText = `
                display: flex;
                align-items: center;
                gap: 5px;
                padding: 3px;
                border-radius: 3px;
                background-color: ${powerUp.type.iconColor}33; /* 20% opaklƒ±k */
            `;
            
            // ƒ∞kon
            const icon = document.createElement('div');
            icon.textContent = powerUp.type.iconSymbol;
            icon.style.cssText = `
                width: 20px;
                height: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 16px;
                color: ${powerUp.type.iconColor};
            `;
            activeItem.appendChild(icon);
            
            // ƒ∞sim
            const name = document.createElement('div');
            name.textContent = powerUp.type.name;
            name.style.cssText = `
                color: white;
                font-family: Arial, sans-serif;
                font-size: 12px;
                flex-grow: 1;
            `;
            activeItem.appendChild(name);
            
            // Kalan s√ºre
            const time = document.createElement('div');
            time.textContent = `${remainingSeconds}s`;
            time.style.cssText = `
                color: white;
                font-family: Arial, sans-serif;
                font-size: 12px;
                width: 30px;
                text-align: right;
            `;
            activeItem.appendChild(time);
            
            activeContainer.appendChild(activeItem);
        });
        
        // Aktif g√º√ß-up yoksa mesaj g√∂ster
        if (this.activePowerUps.length === 0) {
            activeContainer.style.display = 'none';
        } else {
            activeContainer.style.display = 'flex';
        }
    }
}

// G√º√ß-up sistemini dƒ±≈üa aktar
window.PowerUpSystem = {
    PowerUpManager,
    POWERUP_TYPES
};